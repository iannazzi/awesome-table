<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>

    <title>Awesome Table</title>

    <script src='../../node_modules/jquery/dist/jquery.js'></script>
    <script src='../../dist/awesome-table-dist.js'></script>
    <!--need to run column definition class through webpack so I can use it..... -->
    <script src='globalDemoDist/column-defintion.js'></script>
</head>
<body>
    <a href="index.html">Home</a>
    <h1>Purchase Order</h1>
    <div id='table'></div>
    <h1>Testing Results</h1>
    <div id='test_div'></div>
</body>
<script>

    //setup
    let purchaseOrderTable = new AwesomeTable.AwesomeTable('collection');
    let column_definition = new ColumnDefinition.ColumnDefinition();
    //we need a few events... these can attach to the column definition.....

    let updateTotal = function(event){
        //update total whenever quantity is changed or cost is changed....
        let r = purchaseOrderTable.getRow(event.srcElement);

        let qty = purchaseOrderTable.getValue('qty', r);
        let cost = purchaseOrderTable.getValue('cost', r);
        let total = qty*cost;
        purchaseOrderTable.setValue('total', r, total);
    }
    let updateQuantity = function(event){
        //update quantity whenever a size array value changes
        let r = purchaseOrderTable.getRow(event.srcElement);
        let sum = purchaseOrderTable.model.sumArray('sizes',r);
        //now set a value....
        purchaseOrderTable.setValue('qty', r, sum);
        //call update total..... how?
        updateTotal(event);
    }
    let config = {
        name: 'purchaseOrderTable',
        data: [], //data1.data.records,
        onChange: function (args, r, c) {
            //we have access to this for any table changes....


//            console.log('active row using one method.... ' + purchaseOrderTable.view.activeRow);
//            console.log('row ' + r);
//            console.log('col ' + c);
//
//            //here is the element that changed....
//            console.log('index of array : ' + args.element.array_index);
//            // I also have the column definition
//            console.log(args.col_def);

            //we can update quantites when the table changes


//            let sum = purchaseOrderTable.model.sumArray('sizes',r);
//            //now set a value....
//            purchaseOrderTable.setValue('qty', r, sum);
//            //now update the total for the line...
//            let cost = purchaseOrderTable.getValue('cost', r);
//            let total = sum*cost;
//            purchaseOrderTable.setValue('total', r, total);


        },
        column_definition: column_definition.purchaseOrder(purchaseOrderTable, updateQuantity, updateTotal),
        table_buttons: ['addRow','deleteRow','deleteAllRows', 'moveRows','copyRows', 'edit'],
        access: 'write', //read vs write
    }
    console.log(config);
    purchaseOrderTable.loadConfiguration(config);
    purchaseOrderTable.addTo('table')





    //size.onChange updateQuantitty
    //

    //to update quantity I would need to
    //find the row in question....
    //get the sum of an array
    //update quantity
    //update the column totals and any footers....

    //this makes an event like size changed, updates the view, then copies the entire table.... seems lame
//    purchaseOrderTable.view.updateQuantity = new TableEvent(purchaseOrderTable.view);
//    purchaseOrderTable.view.updateQuantity.attach(
//        function (sender, event) {
//            //third attempt. After the view renders calculate row totals
//            console.log('updateQuantityEvent');
//            view.elements.forEach((row, r) => {
//                let sum = 0;
//                row.sizes.forEach(size => {
//                    sum += math.myParseFloat(size.value);
//                })
//                view.elements[r]['qty'].value = sum;
//            });
//            //unfortunately we need to update the header/footer again....
//
//            controller.copyTable();
//            view.updateTotalsBody();
//
//
//            // method one to find the element
//            //on model change sum up the rows
//            //this will not work because....
//            //addrow from controller
//            //add row to model
//            //model notifies the change
//            //this code then goes through the view which has not changed
//            //controller updates the view
//
//            //therefore we need to operate on the model itself
//            //but the model re-renders the view and we do not want to touch that..... hmmmm
//
//
//            // let element = event.target;
//            // let row = controller.getElementRow(element);
//            // let sum = 0;
//            // controller.view.elements[row]['sizes'].forEach(size =>{
//            //     sum += math.myParseFloat(size.value);
//            // });
//            // controller.view.elements[row]['qty'].value = sum;
//            // controller.copyTable();
//
//
//            //we could update the view, but we should update the model
//            //Method 1 - interferes with user input
//            //controller.copyTable() is already fired onkeyup
//            // controller.model.tdo[row].sizes.data.forEach(size =>{
//            //     sum += math.myParseFloat(size);
//            // });
//            // controller.model.tdo[row]['qty']['data'] = sum;
//            // controller.model.modelChanged.notify(); //re-render of the table will occur
//
//            //method 2... works like a charm
//
//
//        }
//    );
//    view.dataTableChanged.attach(function () {
//        console.log('datatable changed')
//        //this should fire whenever we say updateTable
//        //there are no elements...
//        view.updateQuantity.notify();
//    });







    //test
    //get a value on the page
    let value = document.getElementById('purchaseOrderTable_r0c3').value;
    //get the same value from the model
    let value2 = purchaseOrderTable.getValue('sizes', 0);

    console.log(value2);
    let p = document.createElement('p');
    p.id = 'test1';
    p.innerHTML = value;
    test_div.appendChild(p);

    //add a row
    purchaseOrderTable.view.addRowClicked.notify();

    //now check the quantity




</script>
</html>
<style>
    body{ margin:30px;}
</style>